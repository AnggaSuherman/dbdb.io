{% extends 'base.html' %}
{% load staticfiles %}
{% load bootstrap4 %}

{% block title %}
Browse
{% endblock %}


{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'lib/css/nouislider.min.css' %}">
<style>
#content { padding:40px 0; }

nav.letters { text-align: center; }
nav.letters.no-results { display:table; width:100%; vertical-align:center; }
nav.letters.no-results div.letters { display:table-cell; height: 75vh; text-align: center; vertical-align:middle; }

form.main-search > div.filters > div.filter-group-range { margin-bottom:30px; }
form.main-search > div.filters > div.filter-group-range > h3 { font-weight:bold; margin-bottom:15px; }
form.main-search > div.filters > div.filter-group-range > h3 span.years { display:none; font-size:0.85em; font-weight:normal; padding-left:0.5em; }
form.main-search > div.filters > div.filter-group-range > h3 span.years var { font-style:normal; }
form.main-search > div.filters > div.filter-group-range > h3 button.btn { float:right; font-size:12px; padding:1px 6px; }
form.main-search > div.filters > div.filter-group-range > h3 button.btn-apply { background-color:#49AA55; color:#fff; display:none; margin-right:5px; }
form.main-search > div.filters > div.filter-group-range > h3 button.btn-toggle { background-color:#6c757d; color:#fff; }
form.main-search > div.filters > div.filter-group-range.active > h3 button.btn-toggle { background-color:#244A64; }
form.main-search > div.filters > div.filter-group-range.active > h3 span.years { display:inline; }
form.main-search > div.filters > div.filter-group-range.changed > h3 button.btn-apply { display:inline; }
form.main-search > div.filters > div.filter-group-range > div.range-container { padding:0 20px; }
form.main-search > div.filters > div.filter-group-range > div.range-container .noUi-connect { background-color:#007bff; }

div.results { min-height: 60vh; padding:40px 40px 30px 40px; }
div.results div.version { margin-bottom:20px; max-width:800px; }
div.results div.version h3 { font-size:20px; margin:0; }
div.results div.version cite { color:#006621; font-size:13px; font-style:normal; }
div.results div.version p { margin:0; }
</style>
{% endblock %}


{% block content %}
<form class="main main-search">

    <div class="filters">

        <h2>Refine by</h2>

        <div class="filter-group filter-group-range" id="start_year" data-min="{{ years.min_start_year }}" data-max="{{ years.max_start_year }}">
            <h3>
                Start Year
                <span class="years">(<var for="min"></var> &ndash; <var for="max"></var>)</span>
                <button type="button" class="btn btn-xs btn-toggle"></button>
                <button type="submit" class="btn btn-xs btn-apply">Apply</button>
            </h3>
            <div class="range-container">
                <div class="range"></div>
            </div>
            <input type="hidden" name="start-min" for="min" value="{{ search.start_min }}" />
            <input type="hidden" name="start-max" for="max" value="{{ search.start_max }}" />
        </div>

         <div class="filter-group filter-group-range" id="end_year" data-min="{{ years.min_end_year }}" data-max="{{ years.max_end_year }}">
            <h3>
                End Year
                <span class="years">(<var for="min"></var> &ndash; <var for="max"></var>)</span>
                <button type="button" class="btn btn-xs btn-toggle"></button>
                <button type="submit" class="btn btn-xs btn-apply">Apply</button>
            </h3>
            <div class="range-container">
                <div class="range"></div>
            </div>
            <input type="hidden" name="end-min" for="min" value="{{ search.end_min }}" />
            <input type="hidden" name="end-max" for="max" value="{{ search.end_max }}" />
        </div>

        {% for filtergroup in filtergroups %}
        <div class="filter-group" id="filtergroup_{{ filtergroup.id }}">

            <h3>
                {{ filtergroup.label }}
                {% if filtergroup.has_checked %}
                <a href="javascript:;" class="clear" title="clear selected"><i class="fas fa-eraser"></i> clear </a>
                {% endif %}
            </h3>

            <ul>
                {% for choice in filtergroup.choices %}
                <li {% if choice.is_hidden %}class="more"{% endif %}><label><input type="checkbox" name="{{ filtergroup.id }}" value="{{ choice.id }}" {% if choice.checked %}checked="checked"{% endif %}> {{ choice.label }}</label></li>
                {% endfor %}
                {% if filtergroup.has_more %}
                <li class="see-more">
                    <a href="javascript:;">Show more</a>
                </li>
                {% endif %}
            </ul>

        </div>
        {% endfor %}

    </div>

    <div class="search-results">
        <div class="input-group input-group-lg">
            <input type="text" class="form-control" placeholder="Begin searching!" aria-label="Begin searching!" aria-describedby="search" name="q" value="{{ query }}">
            <span class="input-group-btn">
                <button class="btn btn-default" type="submit" id="search">Search</button>
            </span>
        </div>

        {% if query %}
        <p class="results-info">
            {% if versions %}
            Found {{ versions|length }} results for "{{ query }}"
            {% else %}
            No results found for "<i>{{ query }}</i>"
            {% endif %}
        </p>
        {% else %}
        <nav class="letters {% if not has_results %}no-results{% endif %}" aria-label="Page navigation example">
            <div class="letters">
                {% for page in pagination %}
                <button type="submit" class="btn {% if page.is_active %}btn-primary active{% else %}btn-secondary{% endif %} {% if page.is_disabled %}disabled{% endif %}" name="letter" value="{{ page.letter }}">{{ page.letter }}</button>
                {% endfor %}
            </div>
        </nav>
        {% endif %}
        
        <!-- RESULTS -->
        <div class="card-columns">
            {% for version in versions %}
                {% include 'core/version-card.html' %}
            {% endfor %}
        </div>
        <!-- END: CARD-COLUMNS -->
    </div>

</form>
{% endblock %}


{% block scripts %}
<script src="{% static 'lib/js/bootstrap-select.js' %}"></script>
<script src="{% static 'lib/js/nouislider.min.js' %}"></script>

<script>
function YearRange(selector) {

    var self = this;
    var $elem = $(selector);
    var $btn_toggle = $elem.find('button.btn-toggle');
    var $input_min = $elem.find('input[for="min"]');
    var $input_max = $elem.find('input[for="max"]');
    var $var_min = $elem.find('var[for="min"]');
    var $var_max = $elem.find('var[for="max"]');
    var $range = $elem.find('div.range');
    var range = $range[0];

    var initial_state = null;
    var min = parseInt( $elem.data('min') , 10 );
    var max = parseInt( $elem.data('max') , 10 );
    var selected_min = $input_min.val() ? parseInt( $input_min.val() , 10 ) : '';
    var selected_max = $input_max.val() ? parseInt( $input_max.val() , 10 ) : '';


    self.update = function update(values, handle) {
        if ( ! $elem.hasClass('active') ) return;

        var val = parseInt( values[handle] , 10 );

        if ( handle == 0 ) {
            $input_min.val(val);
            $var_min.text(val);

            if (val != selected_min) $elem.addClass('changed');
        }
        else if ( handle == 1 ) {
            $input_max.val(val);
            $var_max.text(val);

            if (val != selected_max) $elem.addClass('changed');
        }
    };

    self.toggle = function toggle() {
        if ( $elem.hasClass('active') ) {
            self.disable();
        }
        else {
            self.enable();
        }

        $elem.addClass('changed');
    };

    self.enable = function enable() {
        $elem.addClass('active');
        $range.show();
        $btn_toggle.text('Enabled');

        $input_min.prop('disabled', false);
        $input_max.prop('disabled', false);

        var values = range.noUiSlider.get();
        self.update(values, 0);
        self.update(values, 1);
    };
    
    self.disable = function disable() {
        $elem.removeClass('active');
        $range.hide();
        $btn_toggle.text('Enable');

        $input_min.prop('disabled', true);
        $input_max.prop('disabled', true);

        $input_min.val('');
        $input_max.val('');
    };

    self.init = function init() {
        if ( selected_min && selected_max ) {
            $elem.addClass('active');
        }

        noUiSlider.create(range, {
            connect: true,
            start: [selected_min ? selected_min : min, selected_max ? selected_max : max],
            step: 1,

            range: {
                'min': min,
                'max': max
            }
        });

        range.noUiSlider.on('update', self.update);

        if ( $elem.hasClass('active') ) {
            initial_state = 'active';
            self.enable();
        }
        else {
            initial_state = 'disabled';
            self.disable();
        }

        $btn_toggle.click(self.toggle);

    };


    self.init();
}

$(document).ready(function () {

	new YearRange('#start_year');
	new YearRange('#end_year');

	var $form = $('form.main-search');

	$('.filter-group').each(function(){
		var $clear = $('a.clear', this);
		var $filtergroup = $(this);
		var $seemore = $('li.see-more', this);

		$clear.click(function(){
			$filtergroup.find(':checked').prop('checked', false);
			$form.submit();
		});

		$seemore.find('a').click(function(){
			var $a = $(this);
			var $ul = $a.closest('ul');
			var $more = $ul.find('.more');

			if ( $a.hasClass('active') ) {
				$more.hide();
				$a.text('Show more');
				$a.removeClass('active');
			}
			else {
				$more.show();
				$a.text('Show less');
				$a.addClass('active');
			}
		});
	});

	$('.filter-group :checkbox').change(function(){
		$form.submit();
	});

});
</script>
{% endblock %}
